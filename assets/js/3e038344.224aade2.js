"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[8591],{8361:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>d,toc:()=>h});var t=n(4848),s=n(8453);const i=n.p+"assets/images/example-app-1-e0c7f03f5f04a353ed12d0a3de009161.png",a=n.p+"assets/images/example-app-2-e60432d0dc9555f1779e303a643c239e.png",l={sidebar_position:2},o="Example application",d={id:"framework/data-querying/example",title:"Example application",description:"This example",source:"@site/docs/framework/data-querying/example.md",sourceDirName:"framework/data-querying",slug:"/framework/data-querying/example",permalink:"/docs/framework/data-querying/example",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"frameworkSidebar",previous:{title:"Overview",permalink:"/docs/framework/data-querying/overview"},next:{title:"Overview",permalink:"/docs/framework/security/overview"}},c={},h=[{value:"Query parameters",id:"query-parameters",level:2},{value:"Core components definition",id:"core-components-definition",level:2},{value:"Handler implementation",id:"handler-implementation",level:2},{value:"Filtering logic",id:"filtering-logic",level:3},{value:"Handling total-order-value",id:"handling-total-order-value",level:4},{value:"Handling status",id:"handling-status",level:4},{value:"Response and view wiring",id:"response-and-view-wiring",level:3},{value:"Complete handler code",id:"complete-handler-code",level:3},{value:"OrderService",id:"orderservice",level:2}];function u(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h1,{id:"example-application",children:"Example application"}),"\n",(0,t.jsxs)(r.p,{children:["This ",(0,t.jsx)(r.a,{href:"https://github.com/resoluteworks/invirt/tree/main/examples/data-querying",children:"example"}),"\ncombines capabilities for filters, sorting and pagination in one Invirt application. The setup\nis a (very crude) screen to review online orders with the following requirements:"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:'The user can filter orders by their total value: less than \xa31000, greater than \xa31000, or "All" (no filtering applied).\nOnly one of the three can be applied as they are mutually exclusive. By default, all orders are listed ("All").'}),"\n",(0,t.jsxs)(r.li,{children:["The user can filter orders by their status (Dispatched, Delivered, etc). Any or all of these can be\nselected for filtering and the page will present the combined result set (in essence an ",(0,t.jsx)(r.code,{children:"OR"}),")."]}),"\n",(0,t.jsxs)(r.li,{children:["Filtering will apply an ",(0,t.jsx)(r.code,{children:"AND"})," between the total order value criteria and the order status criteria, i.e. the orders\nreturned must match the selected total value, as well as matching any selected order statuses."]}),"\n",(0,t.jsx)(r.li,{children:"The user can sort the result set ascending and descending by clicking the listing column headers (Created at, Order status, Total value)"}),"\n",(0,t.jsx)(r.li,{children:"The results are paginated (page size 10) and a pagination control allows the user to navigate the complete\nresult set."}),"\n"]}),"\n",(0,t.jsx)("img",{src:i,width:"600"}),"\n",(0,t.jsx)(r.h2,{id:"query-parameters",children:"Query parameters"}),"\n",(0,t.jsx)(r.p,{children:"The query parameter for filtering with the above criteria is defined as follows:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["A ",(0,t.jsx)(r.code,{children:"total-order-value"})," query parameter specifies the filtering to be applied for the total order value","\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["A value of ",(0,t.jsx)(r.code,{children:"less-than-1000"})," would list orders with a total value less than \xa31000"]}),"\n",(0,t.jsxs)(r.li,{children:["A value of ",(0,t.jsx)(r.code,{children:"more-than-1000"})," would list orders with a total value greater than \xa31000"]}),"\n",(0,t.jsx)(r.li,{children:"A missing parameter indicates no filter should be applied for the total order value"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["A ",(0,t.jsx)(r.code,{children:"status"})," query parameter specifies the statuses of the orders to return. This can be combined\nby passing the parameter multiple times: ",(0,t.jsx)(r.code,{children:"?status=DELIVERED&status=IN_TRANSIT"})]}),"\n",(0,t.jsxs)(r.li,{children:["A ",(0,t.jsx)(r.code,{children:"sort"})," query parameter specifies the sort order.","\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"createdAt:ASC|DESC"})," - sort orders by their creation timestamp"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"status:ASC|DESC"})," - sort orders by their current status"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"totalMinorUnit:ASC|DESC"})," - sort orders by their current total value in minor currency units (pence for GBP, cents for USD, etc)"]}),"\n",(0,t.jsxs)(r.li,{children:["When the ",(0,t.jsx)(r.code,{children:"sort"})," parameter is missing, the search defaults to ",(0,t.jsx)(r.code,{children:"createdAt:DESC"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["Pagination information is passed using the ",(0,t.jsx)(r.code,{children:"from"})," and ",(0,t.jsx)(r.code,{children:"size"})," query parameters: ",(0,t.jsx)(r.code,{children:"&from=0&size=10"})]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"core-components-definition",children:"Core components definition"}),"\n",(0,t.jsxs)(r.p,{children:["An ",(0,t.jsx)(r.code,{children:"OrderService"})," exposes a function that allows the application to search orders based on a filtering criteria,\na sort order, and a pagination constraint. This function returns a ",(0,t.jsx)(r.a,{href:"/docs/api/invirt-data/page#recordspage",children:"RecordsPage"}),"."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:"class OrderService {\n    fun searchOrders(filter: DataFilter?, sort: Sort, page: Page): RecordsPage<Order> {\n        // Search in an orders repository and return a RecordsPage<Order>\n    }\n}\n\n"})}),"\n",(0,t.jsxs)(r.p,{children:["An ",(0,t.jsx)(r.code,{children:"OrderHandler"})," maps the default (",(0,t.jsx)(r.code,{children:"/"}),") route to the page in the screenshot above."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:'object OrderHandler {\n\n    operator fun invoke(orderService: OrderService): RoutingHttpHandler = routes(\n        "/" GET { request ->\n            // Get filters/sort/pagination from request parameters\n            // and call OrderService.searchOrders()\n        }\n    )\n}\n'})}),"\n",(0,t.jsx)(r.h2,{id:"handler-implementation",children:"Handler implementation"}),"\n",(0,t.jsxs)(r.p,{children:["The handler is responsible for reading the query parameters defined above and creating the relevant\nobjects to be passed to the ",(0,t.jsx)(r.code,{children:"OrderService"}),". Starting with the easier ones, we can use Invirt's built-in\nextensions to read ",(0,t.jsx)(r.a,{href:"/docs/api/invirt-core/request-extensions#requestsort",children:"sort"})," and\n",(0,t.jsx)(r.a,{href:"/docs/api/invirt-core/request-extensions#requestpage",children:"page"})," information from the request's query parameters."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:"val sort = request.sort() ?: Sort.desc(Order::createdAt.name)\nval page = request.page()\n"})}),"\n",(0,t.jsx)(r.h3,{id:"filtering-logic",children:"Filtering logic"}),"\n",(0,t.jsxs)(r.p,{children:["For filtering we need to first define the handling of the filter query parameters ",(0,t.jsx)(r.code,{children:"total-order-value"})," and ",(0,t.jsx)(r.code,{children:"status"}),"\nbased on the logic described earlier. For this, we will use Invirt's built-in ",(0,t.jsx)(r.code,{children:"queryValuesFilter"}),"."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:'val ordersFilter = queryValuesFilter {\n   Query.optional("total-order-value").filter { value ->\n      when (value) {\n         "less-than-1000" -> Order::totalMinorUnit.lt(1000_00)\n         "more-than-1000" -> Order::totalMinorUnit.gt(1000_00)\n         else -> null\n      }\n   }\n\n   Query.enum<OrderStatus>().multi.optional("status").or { status ->\n      Order::status.eq(status)\n   }\n}\n'})}),"\n",(0,t.jsxs)(r.p,{children:["Several things to unpack here, so let's start with ",(0,t.jsx)(r.code,{children:"queryValuesFilter()"})," itself.\nThis function builds a ",(0,t.jsx)(r.code,{children:"QueryValuesFilter"})," object which stores the configuration\n(lambdas) how to transform query parameters into",(0,t.jsx)(r.a,{href:"/docs/api/invirt-data/data-filter",children:"DataFilter"}),"\nobjects at runtime. This object can then be applied to a ",(0,t.jsx)(r.code,{children:"Request"})," to produce the final\n",(0,t.jsx)(r.code,{children:"DataFilter"}),", or ",(0,t.jsx)(r.code,{children:"null"})," if none of the expected parameters are present."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:'val ordersFilter = queryValuesFilter {...}\n\n"/" GET { request ->\n   val filter: DataFilter? = ordersFilter(request)\n   ...\n}\n'})}),"\n",(0,t.jsxs)(r.p,{children:["The constructs inside the lambda will use http4k's built-in ",(0,t.jsx)(r.a,{href:"https://www.http4k.org/guide/howto/typesafe_your_api_with_lenses/",children:"parameter lensing"}),"\nto start defining an expression for processing a parameter, hence the ",(0,t.jsx)(r.code,{children:"Query."})," chained calls."]}),"\n",(0,t.jsxs)(r.p,{children:["By default, ",(0,t.jsx)(r.code,{children:"queryValuesFilter"})," builds an ",(0,t.jsx)(r.code,{children:"AND"})," compound filter from the individual parameter filters defined in its lambda.\nThis can be overridden by passing ",(0,t.jsx)(r.code,{children:"DataFilter.Compound.Operator.OR"}),"."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:"queryValuesFilter { ... } // Defaults to DataFilter.Compound.Operator.AND\nqueryValuesFilter(DataFilter.Compound.Operator.AND) { ... }\nqueryValuesFilter(DataFilter.Compound.Operator.OR) { ... }\n"})}),"\n",(0,t.jsx)(r.h4,{id:"handling-total-order-value",children:"Handling total-order-value"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.code,{children:"total-order-value"})," is handled as a query parameter that is only passed (and handled) once, i.e. passing the query\nbelow will cause the second value to be ignored, which is what we want in this case."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"&total-order-value=less-than-1000&total-order-value=more-than-1000\n"})}),"\n",(0,t.jsxs)(r.p,{children:["To convert ",(0,t.jsx)(r.code,{children:"total-order-value"})," to a ",(0,t.jsx)(r.code,{children:"DataFilter"})," we start with http4k built-in ",(0,t.jsx)(r.code,{children:'Query.optional("total-order-value")'}),"\nand then call Invirt's ",(0,t.jsx)(r.code,{children:".filter"})," to specify the lambda returning a ",(0,t.jsx)(r.code,{children:"DataFilter"})," for the current value of this parameter.\nIn our case, we have ",(0,t.jsx)(r.code,{children:"when"})," clause defining explicitly what filter is produced for each value\n(or ",(0,t.jsx)(r.code,{children:"null"})," if the passed value doesn't match any of them)."]}),"\n",(0,t.jsx)(r.h4,{id:"handling-status",children:"Handling status"}),"\n",(0,t.jsxs)(r.p,{children:["Http4k's built-ins lensing is used again to convert the parameter to ",(0,t.jsx)(r.code,{children:"OrderStatus"})," enum values and specify that it can\nappear multiple times in the query (",(0,t.jsx)(r.code,{children:".multi"}),")."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:'Query.enum<OrderStatus>().multi.optional("status")\n'})}),"\n",(0,t.jsxs)(r.p,{children:["This then allows us to call an Invirt extension (",(0,t.jsx)(r.code,{children:".or"})," in this case) to specify"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:["How the individual ",(0,t.jsx)(r.code,{children:"DataFilters"})," must be combined when there are multiple values which: OR or AND (",(0,t.jsx)(r.code,{children:".or"})," / ",(0,t.jsx)(r.code,{children:".and"}),"). For our\nrequirements we need an OR for the order status filter."]}),"\n",(0,t.jsxs)(r.li,{children:["How each of the individual ",(0,t.jsx)(r.code,{children:"OrderStatus"})," convert to a ",(0,t.jsx)(r.code,{children:"DataFilter"}),", a simple equals filter, in this case, via ",(0,t.jsx)(r.code,{children:"Order::status.eq(status)"})]}),"\n"]}),"\n",(0,t.jsx)(r.h3,{id:"response-and-view-wiring",children:"Response and view wiring"}),"\n",(0,t.jsxs)(r.p,{children:["To render the orders we will use ",(0,t.jsx)(r.a,{href:"/docs/framework/views-wiring#viewresponse",children:"ViewResponse"}),", which will store\nthe ",(0,t.jsx)(r.code,{children:"RecordsPage<Order>"})," returned by ",(0,t.jsx)(r.code,{children:"OrderService.searchOrders()"}),", to be consumed directly by the template."]}),"\n",(0,t.jsxs)(r.p,{children:["We also want to provide the ",(0,t.jsx)(r.code,{children:"OrderStatus"})," enum values to render the possible options for the order status\nfilter (see image below), so we don't hardcode these in the template which can cause them to drift from the internal enum definition."]}),"\n",(0,t.jsx)("img",{src:a,width:"600"}),"\n",(0,t.jsx)(r.p,{children:"The code for this component would then be fairly straightforward."}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:'private class ListOrdersResponse(\n    val ordersPage: RecordsPage<Order>\n) : ViewResponse("list-orders") {\n\n    val orderStatusValues = OrderStatus.entries\n}\n'})}),"\n",(0,t.jsx)(r.h3,{id:"complete-handler-code",children:"Complete handler code"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-kotlin",children:'object OrderHandler {\n\n    operator fun invoke(orderService: OrderService): RoutingHttpHandler = routes(\n        "/" GET { request ->\n            val filter = filter(request)\n            val sort = request.sort() ?: Sort.desc(Order::createdAt.name)\n            val page = request.page()\n\n            val ordersPage = orderService.searchOrders(filter, sort, page)\n            ListOrdersResponse(ordersPage).ok()\n        }\n    )\n}\n\nprivate val filter = queryValuesFilter {\n    Query.optional("total-order-value").filter { value ->\n        when (value) {\n            "less-than-1000" -> Order::totalMinorUnit.lt(1000_00)\n            "more-than-1000" -> Order::totalMinorUnit.gt(1000_00)\n            else -> null\n        }\n    }\n\n    Query.enum<OrderStatus>().multi.optional("status").or { status ->\n        Order::status.eq(status)\n    }\n}\n\nprivate class ListOrdersResponse(val ordersPage: RecordsPage<Order>) : ViewResponse("list-orders") {\n    val orderStatusValues = OrderStatus.entries\n}\n'})}),"\n",(0,t.jsx)(r.h2,{id:"orderservice",children:"OrderService"}),"\n",(0,t.jsxs)(r.p,{children:["For the OrderService we've used a mock implementation using a local list of random orders, which we then\nsort, filter and paginate in memory. This is done to avoid wiring a persistence layer for this example,\nand to be able to demonstrate the concept and the separation of concerns in its raw form. Because this isn't\nsomething that any application would normally do, we won't go into the details of this, but you can check out the complete\ncode for it ",(0,t.jsx)(r.a,{href:"https://github.com/resoluteworks/invirt/blob/main/examples/data-querying/src/main/kotlin/examples/data/service/OrderService.kt",children:"here"}),"."]})]})}function p(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>l});var t=n(6540);const s={},i=t.createContext(s);function a(e){const r=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);